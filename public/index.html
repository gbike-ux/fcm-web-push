<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>푸시 알림 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>푸시 알림 관리</h1>
        
        <!-- 탭 메뉴 -->
        <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="instant-tab" data-bs-toggle="tab" data-bs-target="#instant" type="button" role="tab">
                    즉시 발송
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto" type="button" role="tab">
                    자동화 등록
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
                    자동화 관리
                </button>
            </li>
        </ul>

        <!-- 탭 내용 -->
        <div class="tab-content" id="myTabContent">
            <!-- 즉시 발송 탭 -->
            <div class="tab-pane fade show active" id="instant" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-body">
                        <form id="instantForm">
                            <!-- 발송 유형 선택 -->
                            <div class="mb-3">
                                <label class="form-label">발송 유형</label>
                                <select class="form-select" id="sendType" required>
                                    <option value="token">단일 토큰</option>
                                    <option value="tokens">다중 토큰</option>
                                    <option value="platform">전체 발송</option>
                                </select>
                            </div>

                            <!-- 토큰 입력 영역 (동적으로 변경됨) -->
                            <div id="tokenInput" class="mb-3">
                                <label class="form-label">FCM 토큰</label>
                                <input type="text" class="form-control" id="singleToken" required>
                                <div class="form-text">토큰은 ':' 문자를 포함하고 100자 이상이어야 합니다.</div>
                            </div>

                            <!-- 플랫폼 선택 (전체 발송 시에만 표시) -->
                            <div id="platformSelect" class="mb-3" style="display: none;">
                                <label class="form-label">플랫폼</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="platform" id="all" value="all" checked>
                                    <label class="btn btn-outline-primary" for="all">전체</label>

                                    <input type="radio" class="btn-check" name="platform" id="ios" value="ios">
                                    <label class="btn btn-outline-primary" for="ios">iOS</label>

                                    <input type="radio" class="btn-check" name="platform" id="android" value="android">
                                    <label class="btn btn-outline-primary" for="android">Android</label>
                                </div>
                            </div>

                            <!-- 알림 내용 -->
                            <div class="mb-3">
                                <label class="form-label">제목</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">내용</label>
                                <textarea class="form-control" id="body" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">이미지 URL</label>
                                <input type="url" class="form-control" id="imageUrl">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">우선순위</label>
                                <select class="form-select" id="priority">
                                    <option value="normal">일반</option>
                                    <option value="high">긴급</option>
                                </select>
                                <div class="form-text">
                                    긴급으로 설정 시:<br>
                                    - Android: 알림 위에 "긴급" 텍스트 표시<br>
                                    - iOS: 방 금지 모드에서도 알림 표 (time-sensitive)
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">앱 링크</label>
                                <input type="text" class="form-control" id="linkUrl" placeholder="예: gcooter://open">
                                <div class="form-text">
                                    <strong>앱 스킴 예시:</strong><br>
                                    - 앱 실행: gcooter://open<br>
                                    - 학원 인증 화면: gcooter://academy-verify<br>
                                    - 메뉴 화면: gcooter://menu<br>
                                    - 카드등록 화면: gcooter://card-register
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">발송</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 자동화 등록 탭 -->
            <div class="tab-pane fade" id="auto" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-body">
                        <form id="autoForm">
                            <!-- 조건 설정 -->
                            <div class="mb-3">
                                <label class="form-label">대상 잠재고객</label>
                                <select class="form-select" id="audienceType" required>
                                    <option value="7일간 활동이 없는 사용자">7일간 활동이 없는 사용자 (143,114명)</option>
                                    <option value="30일간 활동이 없는 사용자">30일간 활동이 없는 사용자 (118,060명)</option>
                                    <option value="맵&QR 눌렀으나 미탑승">맵&QR 눌렀으나 미탑승 (443,070명)</option>
                                    <option value="비구매자">비구매자 (1,121,117명)</option>
                                    <option value="user_is_test_server_user">테스트 사용자 (86명)</option>
                                </select>
                            </div>

                            <!-- 발송 주기 설정 -->
                            <div class="mb-3">
                                <label class="form-label">발송 주기</label>
                                <select class="form-select" id="scheduleType" required>
                                    <option value="0 12 * * *">매일 정오</option>
                                    <option value="0 */6 * * *">6시간마다</option>
                                    <option value="0 10,15,20 * * *">매일 10시, 15시, 20시</option>
                                    <option value="0 12 * * 1">매주 월요일 정오</option>
                                    <option value="0 12 1 * *">매월 1일 정오</option>
                                </select>
                            </div>

                            <!-- 알림 내용 설정 -->
                            <div class="mb-3">
                                <label class="form-label">자동화 규칙 이름</label>
                                <input type="text" class="form-control" id="ruleName" required 
                                    placeholder="예: 7일 미접속자 알림">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">알림 제목</label>
                                <input type="text" class="form-control" id="autoTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">알림 내용</label>
                                <textarea class="form-control" id="autoBody" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">이미지 URL</label>
                                <input type="url" class="form-control" id="autoImageUrl">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">앱 링크</label>
                                <input type="text" class="form-control" id="autoLinkUrl" 
                                    placeholder="예: gcooter://open">
                                <div class="form-text">
                                    <strong>앱 스킴 예시:</strong><br>
                                    - 앱 실행: gcooter://open<br>
                                    - 학원 인증 화면: gcooter://academy-verify<br>
                                    - 메뉴 화면: gcooter://menu<br>
                                    - 카드등록 화면: gcooter://card-register
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">자동화 등록</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 자동화 관리 탭 -->
            <div class="tab-pane fade" id="manage" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-body">
                        <!-- 통계 섹션 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">총 자동화 규칙</h6>
                                        <h3 id="totalRules">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">오늘 발송된 알림</h6>
                                        <h3 id="todayNotifications">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">활성 규칙</h6>
                                        <h3 id="activeRules">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">성공률</h6>
                                        <h3 id="successRate">0%</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 자동화 규칙 목록 -->
                        <h5 class="mb-3">자동화 규칙 목록</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>조건</th>
                                        <th>제목</th>
                                        <th>상태</th>
                                        <th>생성일</th>
                                        <th>발송수</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="automationRules">
                                    <!-- 자동화 규칙이 여기에 동적으로 추가됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 표시 -->
        <div id="result" class="alert mt-3" style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 토큰 유효성 검사 함수
        function isValidToken(token) {
            return token && token.includes(':') && token.length >= 100;
        }

        // 결과 메시지 표시 함수
        function showResult(tabId, success, message, details = null) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `alert ${success ? 'alert-success' : 'alert-danger'} mt-3`;
            
            if (details) {
                resultDiv.innerHTML = `
                    <h5>${message}</h5>
                    ${Object.entries(details).map(([key, value]) => `<p>${key}: ${value}</p>`).join('')}
                `;
            } else {
                resultDiv.textContent = message;
            }
            
            resultDiv.style.display = 'block';
            
            // 5초 후 메시지 숨기기
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        // 발송 유형에 따른 입력 필드 변경
        document.getElementById('sendType').addEventListener('change', function() {
            const tokenInput = document.getElementById('tokenInput');
            const platformSelect = document.getElementById('platformSelect');
            
            switch(this.value) {
                case 'token':
                    tokenInput.innerHTML = `
                        <label class="form-label">FCM 토큰</label>
                        <input type="text" class="form-control" id="singleToken" required>
                        <div class="form-text">토큰은 ':' 문자를 포함하고 100자 이상이어야 합니다.</div>
                    `;
                    tokenInput.style.display = 'block';
                    platformSelect.style.display = 'none';
                    break;
                case 'tokens':
                    tokenInput.innerHTML = `
                        <label class="form-label">FCM 토큰 목록 (줄바꿈으로 구분)</label>
                        <textarea class="form-control" id="multipleTokens" rows="3" required></textarea>
                        <div class="form-text">각 토큰은 ':' 문자를 포함하고 100자 이상이어야 합니다.</div>
                    `;
                    tokenInput.style.display = 'block';
                    platformSelect.style.display = 'none';
                    break;
                case 'platform':
                    tokenInput.style.display = 'none';
                    platformSelect.style.display = 'block';
                    break;
            }
        });

        // 즉시 발송 폼 제출
        document.getElementById('instantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const sendType = document.getElementById('sendType').value;
                const title = document.getElementById('title').value;
                const body = document.getElementById('body').value;
                const imageUrl = document.getElementById('imageUrl').value;

                // 토큰 유효성 검사
                if (sendType === 'token') {
                    const token = document.getElementById('singleToken').value;
                    if (!isValidToken(token)) {
                        throw new Error('유효하지 않은 FCM 토큰입니다.');
                    }
                } else if (sendType === 'tokens') {
                    const tokens = document.getElementById('multipleTokens').value
                        .split('\n')
                        .map(t => t.trim())
                        .filter(t => t);
                    
                    if (tokens.length === 0) {
                        throw new Error('최소 하나의 토큰이 필요합니다.');
                    }
                    
                    const invalidTokens = tokens.filter(t => !isValidToken(t));
                    if (invalidTokens.length > 0) {
                        throw new Error(`${invalidTokens.length}개의 유효하지 않은 토큰이 있습니다.`);
                    }
                }

                let requestBody = {
                    title,
                    body,
                    data: {
                        type: 'greeting',
                        sender: 'FCM 테스트',
                        click_action: document.getElementById('linkUrl').value.trim() || 'gcooter://open'
                    },
                    android: {
                        priority: document.getElementById('priority').value,
                        notification: {
                            priority: document.getElementById('priority').value
                        }
                    },
                    apns: {
                        headers: {
                            "apns-priority": document.getElementById('priority').value === 'high' ? "10" : "5"
                        },
                        payload: {
                            aps: {
                                alert: {
                                    title,
                                    body
                                },
                                'content-available': 1
                            }
                        }
                    }
                };

                if (imageUrl.trim()) {
                    requestBody.imageUrl = imageUrl;
                }

                switch(sendType) {
                    case 'token':
                        requestBody.token = document.getElementById('singleToken').value.trim();
                        break;
                    case 'tokens':
                        requestBody.tokens = document.getElementById('multipleTokens').value
                            .split('\n')
                            .map(t => t.trim())
                            .filter(t => t);
                        break;
                    case 'platform':
                        requestBody.platform = document.querySelector('input[name="platform"]:checked').value;
                        break;
                }

                const response = await fetch('/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.results) {
                        showResult('instant', true, '알림 전송 결과', {
                            '성공': `${data.results.success}건`,
                            '실패': `${data.results.failure}건`,
                            '전체 토큰': `${data.results.totalTokens}개`,
                            '유효한 토큰': `${data.results.validTokens}개`
                        });
                    } else {
                        showResult('instant', true, '알림이 성공적으로 전송되었습니다.');
                    }
                    
                    // 폼 초기화
                    e.target.reset();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showResult('instant', false, `전송 실패: ${error.message}`);
            }
        });

        // 자동화 등록 폼 제출
        document.getElementById('autoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = {
                    name: document.getElementById('ruleName').value,
                    audienceName: document.getElementById('audienceType').value,
                    schedule: document.getElementById('scheduleType').value,
                    notification: {
                        title: document.getElementById('autoTitle').value,
                        body: document.getElementById('autoBody').value,
                        imageUrl: document.getElementById('autoImageUrl').value || undefined,
                        data: {
                            type: 'automation',
                            click_action: document.getElementById('autoLinkUrl').value.trim() || 'gcooter://open'
                        }
                    }
                };

                const response = await fetch('/automation-rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('auto', true, '자동화 규칙이 성공적으로 등록되었습니다.');
                    loadAutomationRules();
                    e.target.reset();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showResult('auto', false, `등록 실패: ${error.message}`);
            }
        });

        // 자동화 규칙 수정
        async function editRule(ruleId) {
            try {
                const response = await fetch(`/automation-rules/${ruleId}`);
                if (!response.ok) throw new Error('규칙을 불러올 수 없습니다.');
                
                const rule = await response.json();
                
                // 자동화 등록 탭으로 이동
                document.getElementById('auto-tab').click();
                
                // 폼 필드 채우기
                const form = document.getElementById('autoForm');
                form.ruleName.value = rule.name;
                form.audienceType.value = rule.audienceName;
                form.scheduleType.value = rule.schedule;
                form.autoTitle.value = rule.notification.title;
                form.autoBody.value = rule.notification.body;
                form.autoImageUrl.value = rule.notification.imageUrl || '';
                form.autoLinkUrl.value = rule.notification.data?.click_action || 'gcooter://open';
                
                // 원래 제출 핸들러 저장
                const originalHandler = form.onsubmit;
                
                // 임시 제출 핸들러 설정
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    try {
                        const formData = {
                            name: form.ruleName.value,
                            audienceName: form.audienceType.value,
                            schedule: form.scheduleType.value,
                            notification: {
                                title: form.autoTitle.value,
                                body: form.autoBody.value,
                                imageUrl: form.autoImageUrl.value || undefined,
                                data: {
                                    type: 'automation',
                                    click_action: form.autoLinkUrl.value.trim() || 'gcooter://open'
                                }
                            }
                        };

                        const response = await fetch(`/automation-rules/${ruleId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            showResult('auto', true, '자동화 규칙이 성공적으로 수정되었습니다.');
                            loadAutomationRules();
                            form.reset();
                            form.onsubmit = originalHandler;
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        showResult('auto', false, `수정 실패: ${error.message}`);
                    }
                };
            } catch (error) {
                showResult('auto', false, `규칙 수정 실패: ${error.message}`);
            }
        }

        // 자동화 규칙 삭제
        async function deleteRule(ruleId) {
            if (!confirm('이 자동화 규칙을 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch(`/automation-rules/${ruleId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('규칙 삭제에 실패했습니다.');
                
                showResult('manage', true, '자동화 규칙이 삭제되었습니다.');
                loadAutomationRules();
            } catch (error) {
                showResult('manage', false, `삭제 실패: ${error.message}`);
            }
        }

        // 자동화 규칙 토글
        async function toggleRule(ruleId, enabled) {
            try {
                const response = await fetch(`/automation-rules/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled })
                });
                
                if (!response.ok) throw new Error('규칙 상태 변경에 실패했습니다.');
                
                showResult('manage', true, `자동화 규칙이 ${enabled ? '활성화' : '비활성화'} 되었습니다.`);
                loadAutomationRules();
            } catch (error) {
                showResult('manage', false, `상태 변경 실패: ${error.message}`);
            }
        }

        // 자동화 규칙 목록 로드
        async function loadAutomationRules() {
            try {
                const response = await fetch('/automation-rules');
                if (!response.ok) throw new Error('규칙 목록을 불러올 수 없습니다.');
                
                const data = await response.json();
                
                // 통계 업데이트
                document.getElementById('totalRules').textContent = data.stats.total;
                document.getElementById('todayNotifications').textContent = data.stats.todaySent;
                document.getElementById('activeRules').textContent = data.stats.active;
                document.getElementById('successRate').textContent = `${data.stats.successRate}%`;
                
                // 규칙 목록 업데이트
                const tbody = document.getElementById('automationRules');
                tbody.innerHTML = data.rules.map(rule => `
                    <tr>
                        <td>${rule.audienceName}</td>
                        <td>${rule.notification.title}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       onchange="toggleRule('${rule.id}', this.checked)"
                                       ${rule.enabled ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>${new Date(rule.createdAt).toLocaleDateString()}</td>
                        <td>${rule.stats?.sent || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="editRule('${rule.id}')">수정</button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteRule('${rule.id}')">삭제</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showResult('manage', false, `규칙 목록 로드 실패: ${error.message}`);
            }
        }

        // 페이지 로드 시 자동화 규칙 로드
        document.addEventListener('DOMContentLoaded', loadAutomationRules);
    </script>
</body>
</html> 